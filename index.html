<!DOCTYPE html>
<html>
<head>
    <title>Снять квартиру в Пензе</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimum-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://telegram.org/js/telegram-web-app.js?56"></script>
	<script src="https://api-maps.yandex.ru/2.1/?apikey=64aee918-edb7-404b-ae99-c3d58f6eb4de&lang=ru_RU" type="text/javascript"></script>
    <style>
        /* Основные стили для страницы */
        body {
            font-family: system-ui, -apple-system, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #f9f9f9;
            min-height: 100vh;
            min-width: 320px;
            font-size: 16px; /* Увеличенный размер шрифта */
        }

        h1 {
            margin: 10px 0;
            font-size: 28px; /* Увеличенный размер шрифта */
            color: #333;
            text-align: center;
        }

        .filter-section {
            width: 90%;
            max-width: 400px;
            background-color: white;
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 8px;
        }

        .filter-section h2 {
            font-size: 18px; /* Увеличенный размер шрифта */
            color: #333;
            margin-bottom: 8px;
        }

        .filter-section .subtitle {
            font-style: italic;
            font-size: 14px;
            color: #707070;
            margin-bottom: 8px;
        }

        .filter-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 8px;
        }

        .filter-buttons button {
            flex: 1 1 calc(50% - 8px);
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: white;
            color: #333;
            cursor: pointer;
            transition: background-color 0.3s, border-color 0.3s;
            font-size: 16px; /* Увеличенный размер шрифта */
        }

        .filter-buttons button.active {
            background-color: #0078A8;
            color: white;
            border-color: #0078A8;
        }

        .price-inputs {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-bottom: 8px;
        }

        .price-inputs input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 16px; /* Увеличенный размер шрифта */
            text-align: center;
            width: 100px;
        }

        .price-inputs input:focus {
            outline: none;
            border-color: #0078A8;
        }

        .price-inputs span {
            font-size: 16px;
            color: #333;
        }

        .link-button {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: #f3f4f6;
            color: #333;
            cursor: pointer;
            font-size: 16px; /* Увеличенный размер шрифта */
            text-align: left;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.3s;
            margin-bottom: 8px;
        }

        .link-button.disabled {
            background-color: #f3f4f6;
            color: #a0a0a0;
            cursor: not-allowed;
        }

        .link-button .arrow {
            font-size: 16px;
            color: #707070;
        }
        
		.save-button {
            width: 90%;
            max-width: 400px;
            padding: 12px;
            border: none;
            border-radius: 5px;
            background-color: #0078A8;
            color: white;
            font-size: 18px; /* Увеличенный размер шрифта */
            cursor: pointer;
        }

        .save-button:hover {
            background-color: #005f87;
        }

        .district-selector {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: white;
            z-index: 1000;
            padding: 20px;
            box-sizing: border-box;
            overflow-y: auto;
        }

        .district-selector h2 {
            font-size: 24px; /* Увеличенный размер шрифта */
            color: #333;
            margin-bottom: 20px;
        }

        .district-selector .close-button {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 24px;
            color: #333;
            cursor: pointer;
        }

        .district-selector .filter-buttons {
            margin-bottom: 20px;
        }

        .district-selector .filter-buttons button {
            width: 100%;
            margin-bottom: 10px;
        }

        .district-selector .finish-button {
            display: block;
            width: fit-content;
            margin: 20px auto 0;
            padding: 10px 16px;
            border: none;
            border-radius: 5px;
            background-color: #0078A8;
            color: white;
            font-size: 16px;
            cursor: pointer;
        }

        .selected-districts {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
            margin-bottom: 8px;
        }

        .selected-districts .district {
            display: flex;
            align-items: center;
            padding: 6px 12px;
            background-color: #f3f4f6;
            border-radius: 20px;
            font-size: 16px; /* Увеличенный размер шрифта */
            color: #333;
        }

        .selected-districts .district .remove {
            margin-left: 8px;
            cursor: pointer;
            color: #707070;
        }

        /* Стили для карты */
        .microdistrict-selector {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: white;
            z-index: 1000;
            padding: 0;
            box-sizing: border-box;
            overflow-y: auto;
        }

        #map {
            height: 100vh; /* Высота карты на весь экран */
            width: 100%;   /* Ширина карты на весь экран */
        }

        /* Стили для кнопок на карте */
        .button-container {
            position: absolute;
            bottom: 5%;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            display: flex;
            gap: 10px;
        }

        #selectButton, #clearMapButton {
            padding: 10px 20px;
            background-color: white;
            color: #707070;
            border: 2px solid #707070;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            text-align: center;
            transition: background-color 0.3s, color 0.3s;
        }

        #selectButton:disabled {
            background-color: #f3f4f6;
            color: #a0a0a0;
            cursor: not-allowed;
            border-color: #ccc;
        }

        #selectButton.active, #clearMapButton:hover {
            background-color: #0078A8;
            color: white;
            border-color: #0078A8;
        }

        /* Кнопка выхода */
        #exitButton {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: white;
            border: 2px solid #707070;
            color: #707070;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

		/* Стили для контейнера с кнопками */
		.filter-actions {
			width: 90%;
			max-width: 400px;
			display: flex;
			justify-content: space-between;
			gap: 10px; /* Отступ между кнопками */
			margin-top: 10px;
			margin-bottom: 20px;
		}
		
		/* Стили для кнопки "Сохранить фильтр" */
		.save-button {
			flex: 1;
			padding: 12px;
			border: none;
			border-radius: 5px;
			background-color: #0078A8;
			color: white;
			font-size: 18px;
			cursor: pointer;
			transition: background-color 0.3s;
		}
		
		.save-button:hover {
			background-color: #005f87;
		}
		
		/* Стили для кнопки "Сбросить всё" */
		.reset-all-button {
			flex: 1;
			padding: 12px;
			border: 1px solid #ccc;;
			border-radius: 5px;
			background-color: #f3f4f6;
			color: #333;
			font-size: 18px;
			cursor: pointer;
			transition: background-color 0.3s;
		}
		
		.reset-all-button:disabled {
			background-color: #f3f4f6;
			color: #a0a0a0;
			cursor: not-allowed;
		}
		
		.reset-all-button:not(:disabled):hover {
			background-color: #e0e0e0;
		}
		
		/* Стили для кнопки "Сбросить" Районы*/
		.reset-button {
			width: auto;
			padding: 10px 20px;
			border: none;
			border-radius: 25px;
			background-color: #f3f4f6;
			color: #333;
			cursor: pointer;
			font-size: 16px;
			text-align: center;
			transition: background-color 0.3s;
		}
		
		.reset-button:hover {
			background-color: #e0e0e0;
		}

        .confirmation-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .confirmation-modal .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .confirmation-modal .modal-content button {
            margin: 10px;
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .confirmation-modal .modal-content button.confirm {
            background-color: #0078A8;
            color: white;
        }

        .confirmation-modal .modal-content button.cancel {
            background-color: #f3f4f6;
            color: #333;
        }

        /* Стили для поиска и кнопки "Найти" */
        .search-container {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
			display: flex;
            align-items: center;
            background-color: white;
            border-radius: 25px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            padding: 5px;
        }

        #searchInput {
            flex: 1;
            padding: 10px;
			width: 150px; /* Новая ширина поля ввода */
            border: none;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
        }

        .search-divider {
            width: 1px;
            height: 24px;
            background-color: #ccc;
            margin: 0 10px;
        }

        #searchButton {
            padding: 8px;
            background-color: transparent;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #searchButton svg {
            width: 24px;
            height: 24px;
        }

        #searchButton:hover svg path {
            fill: #0078A8;
        }

        /* Стили для кнопки "Найти меня" */
        #locateButton {
            position: absolute;
            top: 50%;
            right: 10px;
            transform: translateY(-50%);
            z-index: 1000;
            padding: 10px;
            background-color: white;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        #locateButton svg {
            width: 24px;
            height: 24px;
        }

        #locateButton:hover {
            background-color: #f0f0f0;
        }
    </style>
</head>
<body>
    <h1>Снять квартиру в Пензе</h1>

    <!-- Блок выбора типа жилья -->
    <div class="filter-section" id="roomCountSection">
        <h2>Тип жилья</h2>
        <div class="filter-buttons" id="roomCountButtons">
            <button data-count="ОК">Комната с ОК</button>
            <button data-count="Студия">Студия</button>
            <button data-count="1">1-ком.</button>
            <button data-count="2">2-ком.</button>
            <button data-count="3">3-ком.</button>
            <button data-count="4">4+ ком.</button>
        </div>
    </div>

    <!-- Блок выбора цены -->
    <div class="filter-section">
        <h2>Стоимость, ₽/мес.</h2>
        <div class="price-inputs">
            <input type="text" id="minPrice" placeholder="От 4000" oninput="validatePriceInput(this)" onblur="validatePriceOnBlur(this)">
            <span>-</span>
            <input type="text" id="maxPrice" placeholder="До" oninput="validatePriceInput(this)" onblur="validatePriceOnBlur(this)">
        </div>
    </div>

    <!-- В основном окне выбора микрорайонов -->
    <div class="filter-section">
        <h2>Районы</h2>
        <div class="subtitle">🛈 при выборе Районов выбор Микрорайона будет недоступен</div>
        <button class="link-button" id="districtButton" onclick="openDistrictSelector()">
            Выбор районов
            <span class="arrow">| ></span>
        </button>
        <div class="selected-districts" id="selectedDistricts"></div>
        <button class="link-button" id="microDistrictButton" onclick="openMicroDistrictSelector()">
            Выбор микрорайонов
            <span class="arrow">| ></span>
        </button>
        <div class="selected-districts" id="selectedMicroDistricts"></div>
        <!-- Кнопка "Сбросить" в блоке "Районы" -->
		<button id="clearMainButton" class="reset-button" onclick="clearDistricts()">Сбросить</button>
    </div>

    <!-- Кнопка "Сбросить фильтры" рядом с "Сохранить фильтры" -->
	<div class="filter-actions">
		<button class="save-button" onclick="handleSaveButtonClick()">Сохранить фильтр</button>
		<button class="reset-all-button" onclick="clearAllFilters()" disabled>Сбросить всё</button>
	</div>

    <!-- Блок выбора районов -->
    <div class="district-selector" id="districtSelector">
        <div class="close-button" onclick="closeDistrictSelector()">×</div>
        <h2>Выберите районы</h2>
        <div class="filter-buttons">
            <button data-district="all">Вся Пенза</button>
            <button data-district="Железнодорожный">Железнодорожный</button>
            <button data-district="Ленинский">Ленинский</button>
            <button data-district="Первомайский">Первомайский</button>
            <button data-district="Октябрьский">Октябрьский</button>
            <button data-district="Засечное">Засечное</button>
            <button data-district="Ухтинка">Ухтинка</button>
            <button data-district="Богословка">Богословка</button>
            <button data-district="Бессоновка">Бессоновка</button>
            <button data-district="Чемодановка">Чемодановка</button>
        </div>
        <button class="finish-button" onclick="closeDistrictSelector()">Завершить выбор</button>
    </div>

    <!-- В блоке выбора микрорайонов на карте -->
    <div class="microdistrict-selector" id="microdistrictSelector" style="display: none;">
		<!-- Карта -->
        <div id="map"></div>
        <!-- Поиск и кнопка "Найти" -->
        <div class="search-container">
            <input type="text" id="searchInput" placeholder="Введите адрес (улица, дом)">
            <div class="search-divider"></div>
            <button id="searchButton" onclick="searchAddress()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M10 2C5.58172 2 2 5.58172 2 10C2 14.4183 5.58172 18 10 18C12.125 18 14.078 17.2635 15.617 16.0319L20.2929 20.7071C20.6834 21.0976 21.3166 21.0976 21.7071 20.7071C22.0976 20.3166 22.0976 19.6834 21.7071 19.2929L17.0319 14.617C18.2635 13.078 19 11.125 19 10C19 5.58172 15.4183 2 10 2ZM10 4C14.4183 4 18 7.58172 18 12C18 16.4183 14.4183 20 10 20C5.58172 20 2 16.4183 2 12C2 7.58172 5.58172 4 10 4Z" fill="#707070"/>
                </svg>
            </button>
        </div>

        <!-- Кнопка "Найти меня" -->
        <div id="locateButton" onclick="locateUser()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2C12.5128 2 12.9355 2.38604 12.9933 2.88338L13 3L13.0003 4.31397C16.4809 4.7625 19.2381 7.51999 19.6862 11.0007L21 11C21.5523 11 22 11.4477 22 12C22 12.5128 21.614 12.9355 21.1166 12.9933L21 13L19.686 13.0003C19.2375 16.4805 16.4805 19.2375 13.0003 19.686L13 21C13 21.5523 12.5523 22 12 22C11.4872 22 11.0645 21.614 11.0067 21.1166L11 21L11.0007 19.6862C7.51999 19.2381 4.7625 16.4809 4.31397 13.0003L3 13C2.44772 13 2 12.5523 2 12C2 11.4872 2.38604 11.0645 2.88338 11.0067L3 11L4.31384 11.0007C4.76197 7.51965 7.51965 4.76197 11.0007 4.31384L11 3C11 2.44772 11.4477 2 12 2ZM12 6.25C8.82436 6.25 6.25 8.82436 6.25 12C6.25 15.1756 8.82436 17.75 12 17.75C15.1756 17.75 17.75 15.1756 17.75 12C17.75 8.82436 15.1756 6.25 12 6.25ZM12 8C14.2091 8 16 9.79086 16 12C16 14.2091 14.2091 16 12 16C9.79086 16 8 14.2091 8 12C8 9.79086 9.79086 8 12 8Z" fill="#212121"/>
            </svg>
        </div>
        
        <!-- Кнопки на карте -->
        <div class="button-container">
            <button id="selectButton" disabled>Выбрать район</button>
            <button id="clearMapButton">Очистить</button>
        </div>
        <button id="exitButton" onclick="closeMicroDistrictSelector()">×</button>
    </div>

    <!-- Модальное окно подтверждения выхода -->
    <div class="confirmation-modal" id="confirmationModal">
        <div class="modal-content">
            <p>Фильтры не будут сохранены. Вы уверены, что хотите выйти?</p>
            <button class="confirm" onclick="confirmExit()">Да</button>
            <button class="cancel" onclick="cancelExit()">Нет</button>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
		const WebApp = window.Telegram.WebApp;
		
		function getSelectedFiltersMessage() {
			const selectedRoomCounts = Array.from(document.querySelectorAll('#roomCountButtons .active'))
				.map(btn => btn.dataset.count)
				.join(', ');
		
			const minPrice = document.getElementById('minPrice').value;
			const maxPrice = document.getElementById('maxPrice').value;
		
			const selectedDistricts = Array.from(document.querySelectorAll('.district-selector .filter-buttons button.active'))
				.map(button => button.dataset.district)
				.filter(district => district !== 'all')
				.join(', ');
		
			const selectedMicroDistricts = JSON.parse(localStorage.getItem('selectedMicroDistricts')) || [];
		
			let message = 'Вы выбрали следующие фильтры:\n\n';
			message += `- Тип жилья: ${selectedRoomCounts || 'не выбрано'}\n`;
			message += `- Цена: от ${minPrice || '0'} до ${maxPrice || '∞'}\n`;
			message += `- Районы: ${selectedDistricts || 'не выбрано'}\n`;
			message += `- Микрорайоны: ${selectedMicroDistricts.join(', ') || 'не выбрано'}\n\n`;
			message += 'Сохранить фильтры?';
		
			return message;
		}
		
		function showSaveConfirmation() {
			const message = getSelectedFiltersMessage();
		
			WebApp.showConfirm(message, (isConfirmed) => {
				if (isConfirmed) {
					// Пользователь нажал "Да, то что нужно!"
					saveFilter();
				} else {
					// Пользователь нажал "Посмотреть другие фильтры"
					console.log('Пользователь решил изменить фильтры.');
				}
			});
		}
		// Вызов функции восстановления при загрузке страницы
		document.addEventListener('DOMContentLoaded', () => {
			restoreFilters(); // Восстановление интерфейса
		});
	
		// Функция для восстановления состояния фильтров
		function restoreFilters() {
			// Восстановление выбранных микрорайонов в интерфейсе
			updateSelectedMicroDistricts();
		
			// Восстановление выбранных районов
			const selectedDistricts = JSON.parse(localStorage.getItem('selectedDistricts')) || [];
			if (selectedDistricts.length > 0) {
				selectedDistricts.forEach(district => {
					const button = document.querySelector(`button[data-district="${district}"]`);
					if (button) {
						button.classList.add('active');
					}
				});
				updateSelectedDistricts();
			}
		
			// Восстановление цены
			const minPrice = localStorage.getItem('minPrice');
			const maxPrice = localStorage.getItem('maxPrice');
			if (minPrice) {
				document.getElementById('minPrice').value = minPrice;
			}
			if (maxPrice) {
				document.getElementById('maxPrice').value = maxPrice;
			}
		
			// Восстановление выбранных типов жилья
			const selectedRoomCounts = JSON.parse(localStorage.getItem('selectedRoomCounts')) || [];
			selectedRoomCounts.forEach(count => {
				const button = document.querySelector(`button[data-count="${count}"]`);
				if (button) {
					button.classList.add('active');
				}
			});
		
			// Обновление состояния кнопок
			checkFilters();
			updateResetButton(); // Убедимся, что кнопка "Сбросить" появляется только при выборе районов/микрорайонов
		}
		
		<!-- Восстановление микрорайонов на карте -->
		function restoreMicroDistrictsOnMap() {
			const selectedMicroDistricts = JSON.parse(localStorage.getItem('selectedMicroDistricts')) || [];
			if (selectedMicroDistricts.length > 0 && geojsonLayer) {
				selectedMicroDistricts.forEach(microDistrict => {
					const layer = geojsonLayer.getLayers().find(l => l.feature.properties.Name === microDistrict);
					if (layer) {
						layer.setStyle({
							color: 'red',
							fillColor: 'red',
							fillOpacity: 0.2
						});
						selectedPolygons[microDistrict] = layer;
					}
				});
				updateSelectButtonState();
			}
		}
		
		
		<!-- Основные районы -->
        const mainDistricts = ['Железнодорожный', 'Ленинский', 'Первомайский', 'Октябрьский'];
        const allDistricts = [...mainDistricts, 'Засечное', 'Ухтинка', 'Богословка', 'Бессоновка', 'Чемодановка'];

        <!-- Логика для выбора типа жилья -->
        const roomCountButtons = document.querySelectorAll('#roomCountButtons button');
        roomCountButtons.forEach(button => {
            button.addEventListener('click', () => {
                button.classList.toggle('active');
            });
        });
		
		// Сохранение выбранных типов жилья
		function saveRoomCounts() {
			const selectedRoomCounts = Array.from(document.querySelectorAll('#roomCountButtons .active'))
				.map(btn => btn.dataset.count);
			localStorage.setItem('selectedRoomCounts', JSON.stringify(selectedRoomCounts));
		}

        <!-- Валидация ввода цены (очистка от нечисловых символов) -->
        function validatePriceInput(input) {
            input.value = input.value.replace(/\D/g, '');
        }

        <!-- Валидация при потере фокуса -->
        function validatePriceOnBlur(input) {
            const minPriceInput = document.getElementById('minPrice');
            const maxPriceInput = document.getElementById('maxPrice');

            <!-- Преобразуем значения в числа -->
            const minPrice = parseInt(minPriceInput.value, 10) || 0;
            const maxPrice = parseInt(maxPriceInput.value, 10) || 0;

            if (input === minPriceInput) {
                // Минимальная цена не может быть меньше 4000
                if (minPrice < 4000) {
                    minPriceInput.value = 4000;
                    WebApp.showAlert('Минимальная цена не может быть меньше 4000 рублей.');
                }
            }

            if (input === maxPriceInput && minPriceInput.value) {
                // Максимальная цена не может быть меньше 4000
                if (maxPrice < 4000) {
                    maxPriceInput.value = 4000;
                    WebApp.showAlert('Максимальная цена не может быть меньше 4000 рублей.');
                }

                // Максимальная цена не может быть меньше минимальной
                if (maxPrice < minPrice) {
                    maxPriceInput.value = minPrice;
                    WebApp.showAlert('Максимальная цена не может быть меньше минимальной.');
                }
            }
        }

        // Проверка цены перед сохранением фильтра
        function validatePriceBeforeSave() {
            const minPriceInput = document.getElementById('minPrice');
            const maxPriceInput = document.getElementById('maxPrice');

            // Преобразуем значения в числа
            const minPrice = parseInt(minPriceInput.value, 10) || 0;
            const maxPrice = parseInt(maxPriceInput.value, 10) || 0;

            // Проверка минимальной цены
            if (!minPriceInput.value.trim()) {
                WebApp.showAlert('Пожалуйста, введите минимальную цену.');
                minPriceInput.focus(); // Возвращаем фокус на поле
                return false; // Прерываем сохранение
            }

            if (minPrice < 4000) {
                WebApp.showAlert('Минимальная цена не может быть меньше 4000 рублей.');
                minPriceInput.focus(); // Возвращаем фокус на поле
                return false; // Прерываем сохранение
            }

            // Проверка максимальной цены
            if (!maxPriceInput.value.trim()) {
                WebApp.showAlert('Пожалуйста, введите максимальную цену.');
                maxPriceInput.focus(); // Возвращаем фокус на поле
                return false; // Прерываем сохранение
            }

            if (maxPrice < minPrice) {
                WebApp.showAlert('Максимальная цена не может быть меньше минимальной.');
                maxPriceInput.focus(); // Возвращаем фокус на поле
                return false; // Прерываем сохранение
            }

            return true; // Цена корректна, можно сохранять
        }
		
		// Сохранение цены
		function savePrice() {
			const minPrice = document.getElementById('minPrice').value;
			const maxPrice = document.getElementById('maxPrice').value;
			localStorage.setItem('minPrice', minPrice);
			localStorage.setItem('maxPrice', maxPrice);
		}

        // Открытие блока выбора районов
        function openDistrictSelector() {
            document.getElementById('districtSelector').style.display = 'block';
        }

        // Закрытие блока выбора районов
        function closeDistrictSelector() {
            document.getElementById('districtSelector').style.display = 'none';
        }

        // Обновление выбранных районов
        function updateSelectedDistricts() {
			const selectedDistricts = [];
			allDistricts.forEach(district => {
				const button = document.querySelector(`button[data-district="${district}"]`);
				if (button.classList.contains('active')) {
					selectedDistricts.push(district);
				}
			});
		
			const allButton = document.querySelector('button[data-district="all"]');
			const isAllSelected = mainDistricts.every(district =>
				document.querySelector(`button[data-district="${district}"]`).classList.contains('active')
			);
			allButton.classList.toggle('active', isAllSelected);
		
			const selectedDistrictsContainer = document.getElementById('selectedDistricts');
			selectedDistrictsContainer.innerHTML = selectedDistricts
				.map(district => `
					<div class="district">
						${district}
						<span class="remove" onclick="removeDistrict('${district}')">| ×</span>
					</div>
				`)
				.join('');
		
			const microDistrictButton = document.getElementById('microDistrictButton');
			if (selectedDistricts.length > 0) {
				microDistrictButton.classList.add('disabled');
				microDistrictButton.disabled = true;
			} else {
				microDistrictButton.classList.remove('disabled');
				microDistrictButton.disabled = false;
			}
		
			updateResetButton();
		}

        // Удаление района
        function removeDistrict(district) {
            const button = document.querySelector(`button[data-district="${district}"]`);
            button.classList.remove('active');
            updateSelectedDistricts();
        }

        // Обработка выбора районов
        const districtButtons = document.querySelectorAll('.district-selector .filter-buttons button');
        districtButtons.forEach(button => {
            button.addEventListener('click', () => {
                if (button.dataset.district === 'all') {
                    // Выбор/снятие всех основных районов
                    const isAllSelected = button.classList.contains('active');
                    mainDistricts.forEach(district => {
                        const districtButton = document.querySelector(`button[data-district="${district}"]`);
                        districtButton.classList.toggle('active', !isAllSelected);
                    });
                } else {
                    // Выбор/снятие конкретного района
                    button.classList.toggle('active');
                }
                updateSelectedDistricts();
            });
        });
		
		// Сохранение выбранных районов
		function saveDistricts() {
			const selectedDistricts = Array.from(document.querySelectorAll('.district-selector .filter-buttons button.active'))
				.map(button => button.dataset.district)
				.filter(district => district !== 'all');
			localStorage.setItem('selectedDistricts', JSON.stringify(selectedDistricts));
		}

        // Логика для кнопки "Сбросить"
        function clearDistricts() {
            // Очищаем выбор районов
            const districtButtons = document.querySelectorAll('.district-selector .filter-buttons button.active');
            districtButtons.forEach(button => button.classList.remove('active'));
            updateSelectedDistricts();

            // Очищаем выбор микрорайонов
            localStorage.removeItem('selectedMicroDistricts');
            updateSelectedMicroDistricts();

            // Очищаем карту
            if (geojsonLayer) {
                geojsonLayer.eachLayer(layer => {
                    layer.setStyle(defaultStyle);
                });
            }
            selectedPolygons = {};

            // Возвращаем кнопку "Выбрать район" на карте в неактивное состояние
            const selectButton = document.getElementById('selectButton');
            selectButton.disabled = true;
            selectButton.classList.remove('active');
            selectButton.textContent = "Выбрать район";
        }

        // Обновление состояния кнопки "Сбросить" блок "Районы"
        function updateResetButton() {
			const clearMainButton = document.getElementById('clearMainButton');
			const selectedDistricts = document.querySelectorAll('.district-selector .filter-buttons button.active').length > 0;
			const selectedMicroDistricts = JSON.parse(localStorage.getItem('selectedMicroDistricts')) || [];
		
			if (selectedDistricts || selectedMicroDistricts.length > 0) {
				clearMainButton.style.display = 'block';
			} else {
				clearMainButton.style.display = 'none';
			}
		}

        // Логика для карты
		let map;
		let marker = null;
        var geojsonLayer;
        var selectedPolygons = {};
        var defaultStyle = {
            color: '#3388ff',
            fillColor: '#3388ff',
            fillOpacity: 0.2
        };

        function loadGeoJSONData() {
			if (map) {
				map.setView([53.2, 45.0], 11);
				return;
			}
		
			map = L.map('map').setView([53.2, 45.0], 11);
			L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
				attribution: '© OpenStreetMap contributors'
			}).addTo(map);
		
			var highlightStyle = {
				color: 'red',
				fillColor: 'red',
				fillOpacity: 0.2
			};
		
			function onEachFeature(feature, layer) {
				if (feature.properties && feature.properties.Name) {
					layer.bindPopup(feature.properties.Name);
					layer.on('click', function(e) {
						var featureId = feature.properties.Name;
		
						if (selectedPolygons[featureId]) {
							layer.setStyle(defaultStyle);
							delete selectedPolygons[featureId];
						} else {
							layer.setStyle(highlightStyle);
							selectedPolygons[featureId] = layer;
						}
		
						updateSelectButtonState();
					});
				}
			}

            // Загружаем GeoJSON файл
			fetch('map.geojson')
				.then(response => response.json())
				.then(data => {
					geojsonData = data; // Сохраняем данные
					
					geojsonLayer = L.geoJSON(data, {
						style: defaultStyle,
						onEachFeature: onEachFeature
					}).addTo(map);
					
					// Восстановление микрорайонов на карте
					restoreMicroDistrictsOnMap();
				})
				.catch(error => {
					console.error('Ошибка загрузки GeoJSON:', error);
					WebApp.showAlert('Не удалось загрузить карту микрорайонов');
				});

            // Обработчик кнопки "Завершить выбор"
            var selectButton = document.getElementById('selectButton');
            selectButton.addEventListener('click', function() {
                const selectedMicroDistricts = Object.keys(selectedPolygons);
                localStorage.setItem('selectedMicroDistricts', JSON.stringify(selectedMicroDistricts));
                closeMicroDistrictSelector();
                updateSelectedMicroDistricts();
                updateResetButton();
            });

           // Обработчик кнопки "Очистить" на карте
			var clearMapButton = document.getElementById('clearMapButton');
			clearMapButton.addEventListener('click', function () {
				// Очищаем выбранные полигоны
				selectedPolygons = {};
				geojsonLayer.eachLayer(layer => {
					layer.setStyle(defaultStyle);
				});
			
				// Очищаем поле ввода поиска
				document.getElementById('searchInput').value = '';
			
				// Удаляем маркер, если он есть
				if (marker) {
					map.removeLayer(marker);
					marker = null;
				}
			
				// Центрируем карту на начальных координатах
				map.setView([53.2, 45.0], 11); // Начальные координаты и уровень масштабирования
			
				// Обновляем состояние кнопки "Выбрать район"
				updateSelectButtonState();
			
				// Очищаем сохранённые микрорайоны
				localStorage.removeItem('selectedMicroDistricts');
				updateSelectedMicroDistricts();
				updateResetButton();
			});
        }

        // Обновление состояния кнопки "Выбрать район"
        function updateSelectButtonState() {
            const selectButton = document.getElementById('selectButton');
            if (Object.keys(selectedPolygons).length > 0) {
                selectButton.disabled = false;
                selectButton.classList.add('active');
                selectButton.textContent = "Завершить выбор";
            } else {
                selectButton.disabled = true;
                selectButton.classList.remove('active');
                selectButton.textContent = "Выбрать район";
            }
        }

        // Открытие блока выбора микрорайонов
		function openMicroDistrictSelector() {
			document.getElementById('microdistrictSelector').style.display = 'block';
			// Очищаем поле ввода поиска
			document.getElementById('searchInput').value = '';
			
			if (map) {
				// Очищаем маркеры, если они есть
				if (marker) {
					map.removeLayer(marker);
					marker = null;
				}
				// Обновляем состояние карты
				map.setView([53.2, 45.0], 11);
			} else {
				loadGeoJSONData();
			}
		}

        // Закрытие блока выбора микрорайонов
        function closeMicroDistrictSelector() {
            document.getElementById('microdistrictSelector').style.display = 'none';
        }

        // Обновление выбранных микрорайонов в основном окне
        function updateSelectedMicroDistricts() {
			const selectedMicroDistricts = JSON.parse(localStorage.getItem('selectedMicroDistricts')) || [];
			const selectedMicroDistrictsContainer = document.getElementById('selectedMicroDistricts');
			selectedMicroDistrictsContainer.innerHTML = selectedMicroDistricts
				.map(microDistrict => `
					<div class="district">
						${microDistrict}
						<span class="remove" onclick="removeMicroDistrict('${microDistrict}')">| ×</span>
					</div>
				`)
				.join('');
		
			const districtButton = document.getElementById('districtButton');
			if (selectedMicroDistricts.length > 0) {
				districtButton.classList.add('disabled');
				districtButton.disabled = true;
			} else {
				districtButton.classList.remove('disabled');
				districtButton.disabled = false;
			}
		
			// Обновление состояния кнопки "Сбросить всё"
			checkFilters();
		}

        // Удаление микрорайона
        function removeMicroDistrict(microDistrict) {
			const selectedMicroDistricts = JSON.parse(localStorage.getItem('selectedMicroDistricts')) || [];
			const updatedMicroDistricts = selectedMicroDistricts.filter(district => district !== microDistrict);
			localStorage.setItem('selectedMicroDistricts', JSON.stringify(updatedMicroDistricts));
		
			if (selectedPolygons[microDistrict]) {
				selectedPolygons[microDistrict].setStyle(defaultStyle);
				delete selectedPolygons[microDistrict];
			}
		
			updateSelectedMicroDistricts();
			updateSelectButtonState();
		}
		
		// Сохранение микрорайонов при завершении выбора на карте
		document.getElementById('selectButton').addEventListener('click', () => {
			saveMicroDistricts();
		});
		
		// Сохранение выбранных микрорайонов
		function saveMicroDistricts() {
			const selectedMicroDistricts = Object.keys(selectedPolygons);
			localStorage.setItem('selectedMicroDistricts', JSON.stringify(selectedMicroDistricts));
		}

        // Функция для отправки данных в бот
        function sendDataToBot(data) {
            if (typeof Telegram !== 'undefined' && Telegram.WebApp && Telegram.WebApp.sendData) {
                console.log('Отправка данных в бот:', data); // Отладка
                Telegram.WebApp.sendData(JSON.stringify(data));
                Telegram.WebApp.close(); // Закрываем веб-приложение после отправки
            } else {
                console.log('Данные для отправки:', data);
                WebApp.showAlert('Фильтр сохранен! Данные можно отправить в бот.');
            }
        }

        // Функция для сохранения фильтра
        function saveFilter() {
			const selectedRoomCounts = Array.from(document.querySelectorAll('#roomCountButtons .active')).length;
			if (selectedRoomCounts === 0) {
				WebApp.showAlert('Пожалуйста, выберите хотя бы один тип жилья.');
				return;
			}
		
			// Проверяем цены перед сохранением
			if (!validatePriceBeforeSave()) {
				return; // Если проверка не прошла, прерываем выполнение
			}
		
			const minPrice = document.getElementById('minPrice').value;
			const maxPrice = document.getElementById('maxPrice').value;
		
			const selectedDistricts = Array.from(document.querySelectorAll('.district-selector .filter-buttons button.active'))
				.map(button => button.dataset.district)
				.filter(district => district !== 'all');
			const selectedMicroDistricts = JSON.parse(localStorage.getItem('selectedMicroDistricts')) || [];
		
			if ((selectedDistricts.length === 0 && selectedMicroDistricts.length === 0)) {
				WebApp.showAlert('Пожалуйста, выберите район или микрорайон.');
				return;
			}
		
			// Формируем объект с выбранными фильтрами
			const filters = {
				roomCounts: Array.from(document.querySelectorAll('#roomCountButtons .active')).map(btn => btn.dataset.count),
				minPrice: minPrice,
				maxPrice: maxPrice,
				districts: selectedDistricts,
				microDistricts: selectedMicroDistricts
			};
		
			// Отправляем данные в бот
			sendDataToBot(filters);
		}
		
		function handleSaveButtonClick() {
			showSaveConfirmation(); // Показываем диалог подтверждения
		}
		
		function validateRoomCounts() {
			const selectedRoomCounts = Array.from(document.querySelectorAll('#roomCountButtons .active')).length;
			if (selectedRoomCounts === 0) {
				WebApp.showAlert('Пожалуйста, выберите хотя бы один тип жилья.');
				return false;
			}
			return true;
		}
		
		function validateDistricts() {
			const selectedDistricts = Array.from(document.querySelectorAll('.district-selector .filter-buttons button.active')).length > 0;
			const selectedMicroDistricts = JSON.parse(localStorage.getItem('selectedMicroDistricts')) || [];
			if (!selectedDistricts && selectedMicroDistricts.length === 0) {
				WebApp.showAlert('Пожалуйста, выберите район или микрорайон.');
				return false;
			}
			return true;
		}
		
		function prepareFilters() {
			return {
				roomCounts: Array.from(document.querySelectorAll('#roomCountButtons .active')).map(btn => btn.dataset.count),
				minPrice: document.getElementById('minPrice').value,
				maxPrice: document.getElementById('maxPrice').value,
				districts: Array.from(document.querySelectorAll('.district-selector .filter-buttons button.active'))
					.map(button => button.dataset.district)
					.filter(district => district !== 'all'),
				microDistricts: JSON.parse(localStorage.getItem('selectedMicroDistricts')) || []
			};
		}
		
		const districtIds = {
			"Железнодорожный": 111,
			"Ленинский": 222,
			"Первомайский": 333,
			"Октябрьский": 444,
			"Засечное": 555,
			"Ухтинка": 666,
			"Богословка": 777,
			"Бессоновка": 888,
			"Чемодановка": 999
		};
		
		const microDistrictIds = {"3-Пенза":1,"4-Пенза":2,"Автовокзал":3,"Автодром":4,"Арбековская застава":5,"Ахуны":6,"Барковка":7,"Бессоновка":8,"Бл. Арбеково":9,"Богословка":10,"Бугровка":11,"Весёловка":12,"Ветерок":13,"Воскресеновка село":14,"Газовый":16,"ГПЗ":15,"Дал. Арбеково":17,"Дубрава":18,"Заводской":19,"Западная поляна":20,"Запрудный":21,"Заря":22,"Заря-1":23,"Заря-2":24,"Засурье":25,"Золотаревка":26,"Каланча":28,"КПД":27,"Кривозерье":29,"Лебедевка":30,"Ленинский лесхоз":31,"Леонидовка":32,"Лесной пос.":33,"Лугометрия":34,"Лукоморье":35,"Малая Валяевка":36,"Маньчжурия":37,"Маяк":38,"Мясоптицекомбинат":39,"Нахаловка":40,"о. Пески":68,"Окружная":41,"ПГУ":42,"Побочино":43,"пос. ЗиФ":69,"пос. Камыши-Хвощи":70,"пос. Мичуринский":71,"пос. Монтажный":72,"пос. Нефтяник":73,"пос. Победа":74,"пос. Полевой":75,"пос.Арбеково":76,"Райки":44,"Светлополянское лесничество":45,"Север":46,"Семейный":47,"Совхоз-техникум":48,"Согласие":49,"Сосновка":50,"Спутник":51,"Тамбовская застава":52,"Тепличный":53,"Терновка":54,"Терновка(5-й Микрорайон)":55,"Терновка(Гидрострой)":56,"Терновка(Междуречье)":57,"Терновка(Свинтрест)":58,"Ухтинка":59,"Центр":60,"Центр(Глобус)":61,"Центр(Памятник)":62,"Центр(ТЦ Суворовский)":63,"Цыганский пос.":64,"Чемодановка":65,"Шуист":66,"Южная поляна":67};

        // Функция перекодировки ТОЛЬКО для отправки (не меняет исходные данные)
		function encodeForSend(filters) {
			return {
				...filters, // Копируем все поля без изменений
				districts: filters.districts.map(name => districtIds[name] || name),
				microDistricts: filters.microDistricts.map(name => microDistrictIds[name] || name)
			};
		}
		
		// Функция для проверки размера данных
		function checkDataSize(data) {
			const jsonString = JSON.stringify(data);
			const sizeInBytes = new Blob([jsonString]).size;
			// Ограничение Telegram WebApp - 4096 байт (можно изменить при необходимости)
			return sizeInBytes <= 4096;
		}
		
		// Модифицированная функция отправки (единственное изменение в вашем коде)
		async function sendDataToBot(data) {
			const encodedData = encodeForSend(data); // Перекодируем только перед отправкой
			
			if (!checkDataSize(encodedData)) {
				WebApp.showAlert('Слишком много фильтров. Уменьшите выбор.');
				return;
			}
		
			if (typeof Telegram !== 'undefined' && Telegram.WebApp?.sendData) {
				Telegram.WebApp.sendData(JSON.stringify(encodedData));
				Telegram.WebApp.close();
			} else {
				console.log('Данные для отправки:', encodedData);
			}
		}
		
		// Функция для проверки, есть ли выбранные фильтры
		function checkFilters() {
			const selectedRoomCounts = Array.from(document.querySelectorAll('#roomCountButtons .active')).length > 0;
			const minPrice = document.getElementById('minPrice').value.trim();
			const maxPrice = document.getElementById('maxPrice').value.trim();
			const selectedDistricts = Array.from(document.querySelectorAll('.district-selector .filter-buttons button.active')).length > 0;
			const selectedMicroDistricts = JSON.parse(localStorage.getItem('selectedMicroDistricts')) || [];
		
			const resetAllButton = document.querySelector('.reset-all-button');
			if (selectedRoomCounts || minPrice || maxPrice || selectedDistricts || selectedMicroDistricts.length > 0) {
				resetAllButton.disabled = false; // Активируем кнопку
			} else {
				resetAllButton.disabled = true; // Деактивируем кнопку
			}
		}
		
		// Функция для сброса всех фильтров
		function clearAllFilters() {
			// Очистка выбранных типов жилья
			document.querySelectorAll('#roomCountButtons .active').forEach(button => {
				button.classList.remove('active');
			});
			localStorage.removeItem('selectedRoomCounts');
		
			// Очистка цены
			document.getElementById('minPrice').value = '';
			document.getElementById('maxPrice').value = '';
			localStorage.removeItem('minPrice');
			localStorage.removeItem('maxPrice');
		
			// Очистка районов и микрорайонов
			clearDistricts();
		
			// Обновление состояния кнопки "Сбросить всё"
			checkFilters();
		}
		
		<!-- Логика для кнопки "Сбросить" в блоке "Районы" -->
		function clearDistricts() {
			// Очистка выбранных районов
			document.querySelectorAll('.district-selector .filter-buttons button.active').forEach(button => {
				button.classList.remove('active');
			});
			localStorage.removeItem('selectedDistricts');
			updateSelectedDistricts();
		
			// Очистка микрорайонов
			localStorage.removeItem('selectedMicroDistricts');
			updateSelectedMicroDistricts();
		
			// Очистка карты
			if (geojsonLayer) {
				geojsonLayer.eachLayer(layer => layer.setStyle(defaultStyle));
			}
			selectedPolygons = {};
		
			// Деактивация кнопки "Завершить выбор"
			const selectButton = document.getElementById('selectButton');
			selectButton.disabled = true;
			selectButton.classList.remove('active');
			selectButton.textContent = "Выбрать район";
		
			// Обновление состояния кнопки "Сбросить"
			updateResetButton();
		}
		
		// Вызов функции проверки фильтров при изменении
		document.querySelectorAll('#roomCountButtons button').forEach(button => {
			button.addEventListener('click', checkFilters);
		});
		
		document.getElementById('minPrice').addEventListener('input', checkFilters);
		document.getElementById('maxPrice').addEventListener('input', checkFilters);
		
		document.querySelectorAll('.district-selector .filter-buttons button').forEach(button => {
			button.addEventListener('click', checkFilters);
		});
		
		// Инициализация при загрузке страницы
		document.addEventListener('DOMContentLoaded', checkFilters);
		
		// Обновление сохранения при изменении фильтров
		document.querySelectorAll('.district-selector .filter-buttons button').forEach(button => {
			button.addEventListener('click', () => {
				saveDistricts();
			});
		});
		
		document.getElementById('minPrice').addEventListener('input', savePrice);
		document.getElementById('maxPrice').addEventListener('input', savePrice);
		
		document.querySelectorAll('#roomCountButtons button').forEach(button => {
			button.addEventListener('click', () => {
				saveRoomCounts();
			});
		});

        // Функция для выхода без сохранения
        function showExitConfirmation() {
            document.getElementById('confirmationModal').style.display = 'flex';
        }

        // Подтверждение выхода
        function confirmExit() {
            WebApp.showAlert('Фильтры не сохранены. Возврат в бот...');
            document.getElementById('confirmationModal').style.display = 'none';
        }

        // Отмена выхода
        function cancelExit() {
            document.getElementById('confirmationModal').style.display = 'none';
        }
		
		<!-- Логика для очистки localStorage при нажатии на кнопку "Сбросить" -->
		function clearFilters() {
			localStorage.removeItem('selectedMicroDistricts');
			localStorage.removeItem('selectedDistricts');
			localStorage.removeItem('minPrice');
			localStorage.removeItem('maxPrice');
			localStorage.removeItem('selectedRoomCounts');
		
			// Очистка интерфейса
			document.querySelectorAll('.district-selector .filter-buttons button.active').forEach(button => {
				button.classList.remove('active');
			});
			document.getElementById('minPrice').value = '';
			document.getElementById('maxPrice').value = '';
			document.querySelectorAll('#roomCountButtons button.active').forEach(button => {
				button.classList.remove('active');
			});
			updateSelectedDistricts();
			updateSelectedMicroDistricts();
			updateResetButton();
		}
		
		<!-- document.getElementById('clearMainButton').addEventListener('click', clearFilters); -->

        // Функция для поиска адреса
        function searchAddress() {
			const query = document.getElementById('searchInput').value;
			if (!query) {
				WebApp.showAlert('Пожалуйста, введите адрес для поиска.');
				return;
			}
		
			// Используем Яндекс.Геокодер
			ymaps.geocode(query, { results: 1 }).then(function (res) {
				const firstResult = res.geoObjects.get(0);
				if (!firstResult) {
					WebApp.showAlert('Адрес не найден.');
					return;
				}
		
				const coordinates = firstResult.geometry.getCoordinates(); // Координаты [широта, долгота]
				const address = firstResult.getAddressLine(); // Адрес
		
				// Центрируем карту Leaflet на найденных координатах
				map.setView([coordinates[0], coordinates[1]], 16);
		
				// Удаляем старый маркер, если он есть
				if (marker) {
					map.removeLayer(marker);
				}
		
				// Добавляем новый маркер на карту Leaflet
				marker = L.marker([coordinates[0], coordinates[1]]).addTo(map)
					.bindPopup(address)
					.openPopup();
			}).catch(function (error) {
				console.error('Ошибка при геокодировании:', error);
				WebApp.showAlert('Произошла ошибка при поиске адреса.');
			});
		}
   
        // Функция для поиска местоположения пользователя
        function locateUser() {
			if (!navigator.geolocation) {
				WebApp.showAlert('Ваш браузер не поддерживает Geolocation API.');
				return;
			}
		
			navigator.geolocation.getCurrentPosition(
				(position) => {
					const lat = position.coords.latitude;
					const lon = position.coords.longitude;
		
					// Центрируем карту Leaflet на местоположении пользователя
					map.setView([lat, lon], 16);
		
					// Удаляем старый маркер, если он есть
					if (marker) {
						map.removeLayer(marker);
					}
		
					// Добавляем новый маркер на карту Leaflet
					marker = L.marker([lat, lon]).addTo(map)
						.bindPopup('Вы здесь')
						.openPopup();
				},
				(error) => {
					WebApp.showAlert('Не удалось получить ваше местоположение.');
					console.error('Ошибка Geolocation:', error);
				}
			);
		}
    </script>
</body>
</html>
